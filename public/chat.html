<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Demo chat Twilio</title>
    <script src="https://media.twiliocdn.com/sdk/js/chat/v4.0/twilio-chat.min.js"></script>
</head>
<body>
<label>Ingresa tu nombre de usuario</label>
<input type="text" id="userinput"/>

<div id="token"></div>
<script>
/** @type Client */
let messagingClient

let channelsList = []
/**
 * Gets twilio access token for user, issued by service account.
 *
 * @param {string} username to include as identity
 * @param {function} handler receiving the token received by response
 */
function fetchAccessToken(username, handler) {
    const data = JSON.stringify({identity: username})
    fetch('/token', {
      method: 'POST',
      body: data,
      headers: {
        'Content-Type': 'application/json'
      }
    })
      .then(res => res.json())
      .then(res => handler(res.token))
      .catch(console.warn)
}

function receiveToken(token) {
  console.log(token)
  const output = document.getElementById('token')
  output.innerText = JSON.stringify(token)
}

function connectMessagingClient(token) {
  console.log('received token', { token })
  Twilio.Chat.Client.create(token)
    .then(function (client) {
      messagingClient = client
      console.log({ client, messagingClient })
      messagingClient.on('channelAdded', loadChannelsList)
    })
    .catch(err => { console.warn(err) })
}

function loadChannelsList() {
  /*
  not a good idea, keeps creating channels

  messagingClient.createChannel({
    attributes: { test: true, jesuso: 'yeah' },
    friendlyName: 'soporte',
    isPrivate: true
  })

  */
  messagingClient.getPublicChannelDescriptors()
    .then(function (channels) {
      console.log(channels)
    })
}

{
  const inputEl = document.getElementById('userinput')

  inputEl.addEventListener('keyup', (ev) => {
    const { keyCode } = ev
    if (keyCode === 13) {
      const username = inputEl.value
      fetchAccessToken(username, connectMessagingClient)
    }
  })
}

</script>
</body>
</html>
